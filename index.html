<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ‹¼éŸ³æ•™å­¦ç«™ â€” Pinyin Tutor</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>æ‹¼éŸ³æ•™å­¦ç«™ <small>ï¼ˆPinyin Tutorï¼‰</small></h1>
    <p class="subtitle">å­¦ä¹ æ‹¼éŸ³ã€ç»ƒä¹ å£°è°ƒã€å¬åŠ›ä¸æ‹¼å†™</p>
  </header>

  <main>
    <section id="learning" class="card">
      <h2>å­¦ä¹ æ‹¼éŸ³</h2>
      <div id="lesson-controls">
        <label>ç­›é€‰ï¼š
          <select id="filter-select">
            <option value="all">å…¨éƒ¨</option>
            <option value="initials">å£°æ¯ (initials)</option>
            <option value="finals">éŸµæ¯ (finals)</option>
            <option value="special">æ•´ä½“è®¤è¯»</option>
          </select>
        </label>
        <input id="search" placeholder="æœç´¢æ‹¼éŸ³æˆ–ç¤ºä¾‹è¯ (å¦‚ï¼šma)" />
      </div>

      <div id="syllable-list" class="grid"></div>

      <div id="detail" class="detail">
        <h3 id="detail-syllable">é€‰æ‹©ä¸€ä¸ªæ‹¼éŸ³</h3>
        <div class="controls">
          <button id="play-btn">ğŸ”Š æ’­æ”¾å‘éŸ³</button>
          <button id="show-examples-btn">ç¤ºä¾‹è¯</button>
        </div>
        <p id="detail-description"></p>
        <ul id="examples"></ul>
      </div>
    </section>

    <section id="practice" class="card">
      <h2>å³æ—¶ç»ƒä¹ </h2>
      <div id="practice-area">
        <div id="practice-target" class="big-text"></div>
        <div class="row">
          <input id="answer" placeholder="è¾“å…¥æ‹¼éŸ³å¹¶æ ‡å£°è°ƒï¼Œä¾‹å¦‚ï¼šmÄ / ma1" />
          <button id="check-btn">æ£€æŸ¥</button>
          <button id="next-btn">ä¸‹ä¸€ä¸ª</button>
        </div>
        <p id="feedback" class="feedback"></p>
      </div>
    </section>

    <section id="quiz" class="card">
      <h2>å°æµ‹éªŒï¼ˆéšæœºï¼‰</h2>
      <div id="quiz-area">
        <button id="start-quiz">å¼€å§‹æµ‹éªŒï¼ˆ5é¢˜ï¼‰</button>
        <div id="quiz-question" class="hidden">
          <p id="quiz-prompt"></p>
          <div id="quiz-options" class="grid options"></div>
          <p id="quiz-status"></p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <p>ç¤ºä¾‹é¡¹ç›® Â· å¯å®šåˆ¶ Â· å¦‚æœä½ éœ€è¦åç«¯æˆ–æ›´å¤æ‚åŠŸèƒ½ï¼Œè¯·å‘Šè¯‰æˆ‘</p>
  </footer>

  <script src="script.js"></script>
</body>
</html>
:root{
  --bg:#f7f9fc;
  --card:#ffffff;
  --accent:#2b7de9;
  --muted:#6b7280;
  --success:#16a34a;
  --danger:#dc2626;
  font-family: Inter, "Noto Sans", "Helvetica Neue", Arial, sans-serif;
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:#0f172a;
  line-height:1.4;
  display:flex;
  flex-direction:column;
  min-height:100vh;
  padding:20px;
}

header{margin-bottom:18px}
header h1{margin:0;font-size:1.6rem}
.subtitle{margin:4px 0 0;color:var(--muted)}

main{
  display:grid;
  grid-template-columns: 1fr 360px;
  gap:18px;
  align-items:start;
  flex:1;
}

.card{
  background:var(--card);
  border-radius:10px;
  padding:16px;
  box-shadow:0 6px 18px rgba(15,23,42,0.06);
}

#learning{grid-column:1}
#practice,#quiz{grid-column:2}

#lesson-controls{display:flex;gap:12px;align-items:center;margin-bottom:12px}
#lesson-controls input, #lesson-controls select{padding:6px 8px;border-radius:6px;border:1px solid #e6eef8}

.grid{
  display:grid;
  grid-template-columns: repeat(auto-fill,minmax(120px,1fr));
  gap:10px;
}

.syllable{
  padding:10px;
  border-radius:8px;
  background:linear-gradient(180deg,#ffffff,#f3f9ff);
  text-align:center;
  cursor:pointer;
  border:1px solid rgba(43,125,233,0.08);
}

.syllable .pinyin{font-weight:700;font-size:1.1rem}
.syllable .tone{color:var(--muted);font-size:0.85rem}

.detail{margin-top:14px;padding:12px;background:#fbfdff;border-radius:8px;border:1px solid #eef6ff}
.controls{display:flex;gap:8px;margin:8px 0}
.controls button{padding:6px 10px;border-radius:6px;border:1px solid #dbeafe;background:#ffffff;cursor:pointer}

.big-text{font-size:2rem;font-weight:700;text-align:center;padding:10px}
.row{display:flex;gap:8px;align-items:center;margin-top:8px}
.row input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef8}

.feedback{min-height:1.2rem;margin-top:8px}

.hidden{display:none}

footer{text-align:center;margin-top:18px;color:var(--muted);font-size:0.9rem}

/* Quiz options */
.options{grid-template-columns:repeat(2,1fr)}
.option{
  padding:10px;border-radius:8px;border:1px solid #e6eef8;background:#fff;cursor:pointer;text-align:center;
}
.option.correct{background:linear-gradient(90deg,#ecfdf5,#bbf7d0);border-color:var(--success)}
.option.wrong{background:linear-gradient(90deg,#fff1f2,#fecaca);border-color:var(--danger)}
// ç®€æ˜“æ‹¼éŸ³æ•™å­¦æ•°æ®ï¼ˆæ¼”ç¤ºç”¨ï¼Œå¯æ‰©å±•ï¼‰
const SYLLABLES = [
  {pinyin: "ma1", display: "mÄ", type: "initials", desc: "å¸¸è§éŸ³èŠ‚ï¼šå¦ˆï¼ˆmotherï¼‰", examples: ["å¦ˆ mÄ â€” å¦ˆå¦ˆ", "éª‚ mÃ  â€” è´£å¤‡"]},
  {pinyin: "ma2", display: "mÃ¡", type: "initials", desc: "ä¸Šå‡è°ƒ", examples: ["éº» mÃ¡ â€” å¤§éº»"]},
  {pinyin: "ma3", display: "mÇ", type: "initials", desc: "ä¸Šé™ä¸Šè°ƒ", examples: ["é©¬ mÇ â€” åŠ¨ç‰©"]},
  {pinyin: "ma4", display: "mÃ ", type: "initials", desc: "ç¬¬å››å£°ï¼ˆå»å£°ï¼‰", examples: ["éª‚ mÃ  â€” æ–¥è´£"]},
  {pinyin: "ba1", display: "bÄ", type: "initials", desc: "å£°æ¯ b", examples: ["å…« bÄ â€” æ•°å­—"]},
  {pinyin: "bo1", display: "bÅ", type: "initials", desc: "æ•´ä½“è®¤è¯»ä¸éŸµæ¯ç¤ºä¾‹", examples: ["æ³¢ bÅ â€” æ³¢æµª"]},
  {pinyin: "ai1", display: "Äi", type: "finals", desc: "éŸµæ¯ ai çš„ç¬¬ä¸€å£°", examples: ["çˆ± Ã i â€” çˆ±æƒ…"]},
  // å¯åœ¨æ­¤å¤„ç»§ç»­æ·»åŠ å®Œæ•´æ‹¼éŸ³è¡¨
];

// DOM
const syllableList = document.getElementById('syllable-list');
const detailSyllable = document.getElementById('detail-syllable');
const detailDescription = document.getElementById('detail-description');
const examplesEl = document.getElementById('examples');
const playBtn = document.getElementById('play-btn');
const showExamplesBtn = document.getElementById('show-examples-btn');
const filterSelect = document.getElementById('filter-select');
const searchInput = document.getElementById('search');

const practiceTarget = document.getElementById('practice-target');
const answerInput = document.getElementById('answer');
const checkBtn = document.getElementById('check-btn');
const nextBtn = document.getElementById('next-btn');
const feedback = document.getElementById('feedback');

const startQuizBtn = document.getElementById('start-quiz');
const quizQuestion = document.getElementById('quiz-question');
const quizPrompt = document.getElementById('quiz-prompt');
const quizOptions = document.getElementById('quiz-options');
const quizStatus = document.getElementById('quiz-status');

let current = null;
let practicePool = [...SYLLABLES];

// Helpers
function renderList(list){
  syllableList.innerHTML = '';
  list.forEach(s => {
    const el = document.createElement('div');
    el.className = 'syllable';
    el.dataset.pinyin = s.pinyin;
    el.innerHTML = `<div class="pinyin">${s.display}</div><div class="tone">${s.pinyin}</div>`;
    el.addEventListener('click', () => showDetail(s));
    syllableList.appendChild(el);
  });
}

function showDetail(s){
  current = s;
  detailSyllable.textContent = `${s.display}  â€”  ${s.pinyin}`;
  detailDescription.textContent = s.desc || '';
  examplesEl.innerHTML = '';
  (s.examples || []).forEach(it => {
    const li = document.createElement('li');
    li.textContent = it;
    examplesEl.appendChild(li);
  });
}

function speak(text){
  if(!window.speechSynthesis) return alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒ SpeechSynthesis');
  const utter = new SpeechSynthesisUtterance(text);
  // å°½é‡ä½¿ç”¨ä¸­æ–‡å‘éŸ³ï¼ˆè®¾å¤‡æ”¯æŒæƒ…å†µä¸‹ï¼‰
  utter.lang = 'zh-CN';
  // ç›´æ¥æœ—è¯»æ±‰å­—æˆ–æ‹¼éŸ³ï¼ˆæ•ˆæœå› æµè§ˆå™¨è€Œå¼‚ï¼‰
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

// åˆå§‹æ¸²æŸ“
renderList(SYLLABLES);
showDetail(SYLLABLES[0]);

// è¿‡æ»¤ä¸æœç´¢
filterSelect.addEventListener('change', () => applyFilter());
searchInput.addEventListener('input', () => applyFilter());

function applyFilter(){
  const f = filterSelect.value;
  const q = searchInput.value.trim().toLowerCase();
  const filtered = SYLLABLES.filter(s => {
    if(f !== 'all' && s.type !== f) return false;
    if(!q) return true;
    return s.pinyin.includes(q) || s.display.includes(q) || (s.examples||[]).some(e => e.toLowerCase().includes(q));
  });
  renderList(filtered);
}

// æ’­æ”¾ä¸ç¤ºä¾‹
playBtn.addEventListener('click', () => {
  if(!current) return;
  // ä¼˜å…ˆæœ—è¯»æ±‰å­—ç¤ºä¾‹ä¸­çš„æ±‰å­—ï¼ˆæ›´è‡ªç„¶ï¼‰ï¼›å¦‚æ— åˆ™è¯»æ‹¼éŸ³
  const text = (current.examples && current.examples[0]) || current.pinyin;
  speak(text);
});

showExamplesBtn.addEventListener('click', () => {
  if(!current) return;
  alert((current.examples || []).join('\n') || 'æ— ç¤ºä¾‹');
});

// Practice
function pickRandom(){
  return practicePool[Math.floor(Math.random()*practicePool.length)];
}

function normalizePinyinInput(input){
  // ç®€å•è§„èŒƒåŒ–ï¼šæŠŠå¸¦å£°è°ƒæˆ–æ•°å­—è½¬ä¸ºæ ‡å‡† pinyin æ•°å­—å½¢å¼ï¼Œå¦‚ï¼šmÄ -> ma1, ma1 -> ma1
  input = input.trim().toLowerCase();
  // å¤„ç†ä»¥æ•°å­—æ ‡è°ƒçš„æƒ…å†µ
  const numMatch = input.match(/([a-z]+)([1-5])$/);
  if(numMatch) return `${numMatch[1]}${numMatch[2]}`;
  // ç®€å•å¤„ç†å¸¦éŸ³è°ƒå­—ç¬¦ï¼ˆåªæ”¯æŒå¸¸è§äº”ä¸ªè°ƒï¼‰ï¼Œæ˜ å°„å›æ•°å­—ï¼ˆç¤ºèŒƒï¼‰
  const toneMap = {
    'Ä':'a1','Ã¡':'a2','Ç':'a3','Ã ':'a4',
    'Ã³':'o2','Å':'o1','Ç’':'o3','Ã²':'o4',
    'Ä“':'e1','Ã©':'e2','Ä›':'e3','Ã¨':'e4',
    'Ã­':'i2','Ä«':'i1','Ç':'i3','Ã¬':'i4',
    'Ãº':'u2','Å«':'u1','Ç”':'u3','Ã¹':'u4',
    'Ç˜':'Ã¼2','Çš':'Ã¼3','Çœ':'Ã¼4','Ç–':'Ã¼1'
  };
  // æ›¿æ¢å¸¦è°ƒå­—ç¬¦
  let base = input;
  let toneNum = '';
  for(const k in toneMap){
    if(base.includes(k)){
      const mapped = toneMap[k]; // e.g., a1
      const letter = mapped[0];
      toneNum = mapped.slice(1);
      base = base.replace(k, letter);
    }
  }
  if(toneNum) return base + toneNum;
  return base; // å¦‚æœæ— æ³•è¯†åˆ«ï¼ŒåŸæ ·è¿”å›
}

function setPracticeTarget(s){
  practiceTarget.textContent = s.display;
  practiceTarget.dataset.pinyin = s.pinyin;
  answerInput.value = '';
  feedback.textContent = '';
}

let currentPractice = pickRandom();
setPracticeTarget(currentPractice);

checkBtn.addEventListener('click', () => {
  const user = normalizePinyinInput(answerInput.value);
  const target = currentPractice.pinyin;
  if(!user){
    feedback.textContent = 'è¯·è¾“å…¥ä½ çš„ç­”æ¡ˆ';
    feedback.style.color = 'var(--muted)';
    return;
  }
  if(user === target){
    feedback.textContent = 'âœ” æ­£ç¡®';
    feedback.style.color = 'var(--success)';
  } else {
    feedback.textContent = `âœ– é”™è¯¯ï¼Œæ­£ç¡®ç­”æ¡ˆï¼š${target}`;
    feedback.style.color = 'var(--danger)';
  }
});

nextBtn.addEventListener('click', () => {
  currentPractice = pickRandom();
  setPracticeTarget(currentPractice);
});

// Quiz
startQuizBtn.addEventListener('click', startQuiz);

function startQuiz(){
  const total = 5;
  const pool = shuffle([...SYLLABLES]);
  let index = 0, score = 0;
  quizQuestion.classList.remove('hidden');
  startQuizBtn.disabled = true;
  quizStatus.textContent = `é¢˜ç›® 1/${total}`;
  renderQuiz();

  function renderQuiz(){
    const q = pool[index];
    quizPrompt.textContent = `è¯·ä»é€‰é¡¹ä¸­é€‰æ‹©ä¸æ‹¼éŸ³ ${q.display} ï¼ˆ${q.pinyin}ï¼‰ å¯¹åº”çš„é¡¹ï¼š`;
    const options = makeOptions(q, pool);
    quizOptions.innerHTML = '';
    options.forEach(opt => {
      const btn = document.createElement('div');
      btn.className = 'option';
      btn.textContent = opt.label;
      btn.addEventListener('click', () => {
        // åˆ¤åˆ†å¹¶é«˜äº®
        if(opt.pinyin === q.pinyin){
          btn.classList.add('correct');
          score++;
        } else {
          btn.classList.add('wrong');
          // æ ‡å‡ºæ­£ç¡®ç­”æ¡ˆ
          Array.from(quizOptions.children).forEach(c => {
            if(c.textContent === getLabelByPinyin(q.pinyin)) c.classList.add('correct');
          });
        }
        // ä¸‹ä¸€é¢˜
        Array.from(quizOptions.children).forEach(c => c.style.pointerEvents = 'none');
        setTimeout(() => {
          index++;
          if(index >= total){
            finish();
          } else {
            quizStatus.textContent = `é¢˜ç›® ${index+1}/${total}`;
            renderQuiz();
          }
        }, 800);
      });
      quizOptions.appendChild(btn);
    });
  }

  function finish(){
    quizPrompt.textContent = `æµ‹éªŒç»“æŸï¼å¾—åˆ† ${score}/${total}`;
    quizOptions.innerHTML = '';
    quizStatus.textContent = '';
    startQuizBtn.disabled = false;
    quizQuestion.classList.add('hidden');
  }
}

function makeOptions(correct, pool){
  const opts = [correct];
  // éšæœºæŒ‘é€‰é”™è¯¯é¡¹
  const others = pool.filter(p => p.pinyin !== correct.pinyin);
  shuffle(others);
  while(opts.length < 4 && others.length) opts.push(others.shift());
  return shuffle(opts).map(o => ({label: o.examples && o.examples[0] ? o.examples[0].split('â€”')[0].trim() : o.display, pinyin: o.pinyin}));
}

function getLabelByPinyin(p){
  const item = SYLLABLES.find(s => s.pinyin === p);
  return item ? (item.examples && item.examples[0] ? item.examples[0].split('â€”')[0].trim() : item.display) : p;
}

// Utilities
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
